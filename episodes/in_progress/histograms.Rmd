---
title: "Histograms"
teaching: 0
exercises: 0
---
::::questions
  - "FIXME"
::::

::::objectives
  - "FIXME"
::::  





## What even is a histogram?

We use histograms to visualise the distribution of some continuous variable. 
It have values between a minimum and maximum value (range), but are these values
equally probable? Probably not. 

In a histogram we divide the range in a number of bins, count the number
of observations in each bin, and make a plot with a bar for each bin, where
the height is equivalent to the number of observations in each bin. 

Normally the bins have equal width - equal to the range of the variable (max - min),
divided by the number of bins.

## How do we do that?

Let us look at some data - penguin data:
```{r data-and-library, message = FALSE, warning=FALSE}
library(tidyverse)
library(palmerpenguins)
```


R has a build-in histogram function, `hist()`, which will make a basic histogram,
of the data we provide it with:

```{r}
hist(penguins$bill_length_mm)
```

This is not a very nice looking histogram, and `ggplot2` provides us with a 
more easily customisable `geom_histogram()` function:

```{r}
ggplot(penguins, aes(x=bill_length_mm)) +
  geom_histogram()
```

This is the distibution of the length, in millimeter, of the bill (or beak) of
a selection of penguins. 

By default the `geom_histogram()` function divides the range of the data 
(min = 32.1, max = 59.6 mm) 
into 30 bins. Each bin therefore have a width of 0.9167 mm. The first bin contains
a single penguin, that has a beak that is between 32.1 and 32.1 + 0.9187 mm long.

From this plot we get information about the distribution of bill-lengths of penguins.

There appears to be several different "peaks" in the plot. This is to be expected
as we have three different species of penguins in the data, in addition to
having penguins of both sexes. 

If we want to split the histogram into these different groups, we can use the
possibilities available in `ggplot2`:

```{r}
ggplot(penguins, aes(x=bill_length_mm)) +
  geom_histogram() +
  facet_grid(sex~species)
```

The data now looks a bit more normally distributed. And we can observe that
male penguins tend to have longer beaks than female penguins. We can also
see that the different species of penguins have different bill lengths. 

## How many bins? 

Note the warning we get. 

"using `bins = 30`. Pick better value with `binwidth`"

The choice of number of bins have a big influence on how the data is visualised.
By providing the 
`geom_histogram()` function with an argument, `bins = xx` where `xx` is the number
of bins we can adjust the number of bins:

::::challenge
## Try it yourself

Try to plot the bill_length_mm variable in the penguins dataset with different
numbers of bins.

::::solution
```{r}
ggplot(penguins, aes(x=bill_length_mm)) +
  geom_histogram(bins = 20)
```

::::

::::

By default `geom_histogram()` choses 30 bins. This default value has been chosen
because it is almost never the correct choice. `ggplot2` is an opinionated
package, that tries to force us to make better plots. And this is the reason for
the warning.

## How many bins should we chose?

We should chose the number of bins that best tells the story we want to tell 
about our data. But also the number of bins that does not hide information
about our data. 

The obvious way to do this is to fiddle with the number of bins, and find the
number that best do that. 

But that can feel a bit cheaty. How do we rationalise the number of bins in a 
way that makes sure that this number is not just the one that show what we 
_want_ the data to show, but the number that actually show the data as it is?

A number of heuristics for chosing the "correct" number of bins exist.

::::spoiler
## Why do we call it a heuristic?

A heuristic is a fancy way of saying "rule of thumb". "Heuristic" sounds like 
we know what we are talking about. 

::::



## Different heuristics for chosing number of bins.

To have an approximately consistent way of describing them, we use these
three values:

* *k* for the number of bins
* *h* for the width of the bins
* *n* for the number of observations

We also use a couple of mathematical signs: $\lceil$ and $\rceil$. These are
"ceiling" functions, and simply mean that we round a number up. Rather than rounding
4.01 to 4, we round *up* to 5.

### Freedman-Diaconis 

This heuristic determines the bind-width as:


$$h = 2 \cdot IQR \cdot n^{-1/3}$$
where IQR is the interquartile range of our data, which can be found using the
`IQR()` function.

The number of bins are then found as

$$
k = \lceil \frac{range}{h} \rceil
$$
::::challenge
## Try it yourself

How many bins does Freedman-Diaconis prescribe for making a histogram of the 
bill length of the penguins?

::::solution

Get all the lengths of the penguin bills, excluding missing values:
```{r}
bill_lengths <- penguins$bill_length_mm %>% 
  na.omit()
```

Find $n$:
```{r}
n <- length(bill_lengths)
```
And the inter quartile range:

```{r}
iqr <- IQR(bill_lengths)
```

Now find the recommended bin-width:
```{r}
h <- 2*iqr*n^(-1/3)
```
And then the number of bins:
```{r}
k <- (max(bill_lengths) - min(bill_lengths))/h
```
Remember to take the ceiling:
```{r}
ceiling(k)
```

::::

::::

### Square root rule

The number of bins $k$ are found directly from the number of observations, n:

$$k = \lceil\sqrt{n}\rceil$$

::::challenge
## Try it yourself

According to the Square Root rule, how many bins should we use for a histogram
of the length of penguin bills?

::::solution

Get all the lengths of the penguin bills, excluding missing values:
```{r}
bill_lengths <- penguins$bill_length_mm %>% 
  na.omit()
```

Find $n$:
```{r}
n <- length(bill_lengths)
```

And calculate the square root of $n$, rounded up using the `ceiling()` function:

```{r}
ceiling(sqrt(n))
```
::::
::::

### The Sturges rule

Here we also find $k$ directly from the number of observations:

$$ k = \lceil\log_2(n) + 1\rceil $$
An implicit assumption is that the data is approximately normally distributed.

$\log_2$ is found using the `log2()` function.


::::challenge
## Try it yourself

According to the Sturgess rule, how many bins should we use for a histogram
of the length of penguin bills?

::::solution

Get all the lengths of the penguin bills, excluding missing values:
```{r}
bill_lengths <- penguins$bill_length_mm %>% 
  na.omit()
```

Find $n$:
```{r}
n <- length(bill_lengths)
```

Now find $k$
```{r}
k <- log2(n) + 1
```

And remember to round up:

```{r}
ceiling(k)
```

::::
::::

### The Rice Rule

Again we get $k$ directly from $n$:

$$k = \lceil 2n^{1/3}\rceil$$
::::challenge

According to the Rice rule, how many bins should we use for a histogram
of the length of penguin bills?
::::solution

Get all the lengths of the penguin bills, excluding missing values:
```{r}
bill_lengths <- penguins$bill_length_mm %>% 
  na.omit()
```

Find $n$:
```{r}
n <- length(bill_lengths)
```

And then find $k$:
```{r}
k <- 2*n^(1/3)
```

Remember to round up:
```{r}
ceiling(k)
```
::::
::::

### Doanes Rule

This rule is a bit more complicated:

$$k= 1 + \log_2(n) + \log_2(1+ |g_1|/\sigma_{g1})$$

$|g_1|$ is the absolute value of the estimated 3rd moment skewness of the data,
found by using the `skewness()` function from the `e1071` package, and 
$\sigma_{g1}$ is found by:

$$\sigma_{g1} = \sqrt{6(n-2)/((n+1)(n+3))}$$

Doanes rule basically adds extra bins based on how skewed the data is, and 
works better than Sturges' rule for non-normal distributions.



### Scott's rule

Here we get the bin-width $h$ using this expression:


$$h = 3.49 \frac{\sigma}{n^{-1/3}}$$ 
Where $\sigma$ is the standard deviation of the data.

## That is difficult

Rather than doing these calculations on our own, we can read the help file for
the `hist()` function. The argument `breaks` allow us to specify where the
breaks in the histogram - the splits in bins - should occur. 

We can see that the default value is "Sturges". And under details we can 
see the other options that `hist()` can work with, "Scott" and "FD" for 
Freedman-Diaconis. We also get a hint of the functions that can return 
the number of bins:

```{r}
nclass.Sturges(penguins$bill_length_mm)
```
`nclass.FD` and `nclass.scott` works similarly, but note that it is necessary
to remove missing values.


::::spoiler
### Shimazaki and Shinomoto - a very fancy way of doing it

This heuristic is described in Shimazaki and Shinomoto. Neural Comput, 2007, 19(6), 1503-1527. 

Divide the range in N bins with a width of $\Delta$. Count the number of observations
in each bin. Call that $k_i$ where the "i" denotes which bin we are looking at.

Calculate the mean k, and variance v of observations in each bin:

$k = 1/n \sum_{i=1}^{N} k_i$

$v = 1/N \sum_{i=1}^N(k_i - k)^2$

Now calculate a new value $C(\Delta)$:

$$C(\Delta) = 2k - v/\Delta^2$$

Adjust $\Delta$ to minimize $C(\Delta)$.

::::

## Another way

We are able to define the bins in two ways. We can specify the number of bins
and we can specify the width of the bins. With a given range of data, those are
equivalent. A better way of specifying them will often be to specify the 
breaks. Remember that the default 30 bins leads to a width of the bins of
0.9noget mm. Which means that the first bin counts bill lenghts in the 
range NOGET TIL NOGET.

Instead of that, it is often a good idea to chose more meaningful breaks

MED HELE TAL OG SÅDAN NOGET.

`geom_histogram` i ggplot2 understøtter ikke at man kan angive hvilken
metode man ønsker at bruge til at beregne breaks i ens data. Så
der må man gøre det selv, eksempelvis med Sturges:

```{r}
bins <- ceiling(log2(length(penguins$bill_length_mm))) + 1
penguins %>% 
  ggplot(aes(x = bill_length_mm)) +
  geom_histogram(bins = bins)
```


Bruger man i stedet en metode der giver os bredden af bins, 
binwidth, gøres det på denne måde:

```{r}
binwidth <- 2*IQR(penguins$bill_length_mm, na.rm = T)*length(penguins$bill_length_mm)^(-1/3)

penguins %>% 
  ggplot(aes(x = bill_length_mm)) +
  geom_histogram(binwidth = binwidth)
```

## Hvilken skal man så vælge?

Man skal vælge det antal bins, eller den bredde af bins, der 
viser hvad man gerne vil have frem i sit histogram. 

Når man så har fundet ud af at 11 bins er det bedste antal, så 
finder man den tommelfingerregel af de ovenstående, der giver tallet
11, og forklarer at antallet af bins er valgt efter den regel.


We can use a function to make the choice. The package `healthyR` has been 
written to work with medical data, and includes the function `opt_bin`,
that claims to find the optimal number of bins:


```{r, warnings = FALSE, message=FALSE}
library(healthyR)
healthyR::opt
penguins %>% 
  filter(!is.na(bill_length_mm)) %>% 
  opt_bin( bill_length_mm)
```
Som det fremgår er man nødt til at fjerne NA-værdier selv, funktionen
har ikke et na.rm argument. Og det vi får ud, er ikke antallet af bins,
men de breaks der skal være i data for at vi får de 18 bins som 
funktionen siger at vi skal have.




::::keypoints
  - "FIXME"
::::
