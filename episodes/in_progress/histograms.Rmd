---
title: "Histograms"
teaching: 0
exercises: 0
---
::::questions
  - "FIXME"
::::

::::objectives
  - "FIXME"
::::  





## What even is a histogram?

We use histograms to visualise the distribution of some continuous variable. 
It have values between a minimum and maximum value (range), but are these values
equally probable? Probably not. 

In a histogram we divide the range in a number of bins, count the number
of observations in each bin, and make a plot with a bar for each bin, where
the height is equivalent to the number of observations in each bin. 

## How do we do that?

Let us look at some data - penguin data:
```{r data-and-library, message = FALSE}
library(tidyverse)
library(palmerpenguins)
```


R has a build in histogram function, `hist()`, which will make a basic histogram,
of the data we provide it with:

```{r}
hist(penguins$bill_length_mm)
```

This is not a very nice looking histogram, and `ggplot2` provides us with a 
more easily customisable histogram function:

```{r}
ggplot(penguins, aes(x=bill_length_mm)) +
  geom_histogram()
```

This is the distibution of the length, in millimeter, of the bill (or beak) of
a selection of penguins. 

By default the `geom_histogram` divides the range of the data (min = 32.1, max = 59.6 mm) 
into 30 bins. Each bin therefore have a width of 0.9167 mm. The first bin contains
a single penguin, that has a beak that is between 32.1 and 32.1 + 0.9187 mm long.

From this plot we get information about the distribution of bill-lengths of penguins.

There appears to be several different "peaks" in the plot. This is to be expected
as we have three different species of penguins in the data, in addition to
having penguins of both sexes. 

If we want to split the histogram into these different groups, we can use the
possibilities available in `ggplot2`:

```{r}
ggplot(penguins, aes(x=bill_length_mm)) +
  geom_histogram() +
  facet_grid(sex~species)
```

The data now looks a bit more normally distributed. And we can observe that
male penguins tend to have longer beaks than female penguins. We can also
see that the different species of penguins have different bill lengths. 

## How many bins? 

Note the warning we get. 

"using `bins = 30`. Pick better value with `binwidth`"

The choice of number of bins have a big influence on how the data looks. We
can hide variation by chosing fewer bins. We do that by providing the 
`geom_histogram()` function with an argument, `bins = xx` where `xx` is the number
of bins we want:

::::challenge
## Try it yourself

Try to plot the bill_length_mm variable in the penguins dataset with different
numbers of bins.

::::solution
```{r}
ggplot(penguins, aes(x=bill_length_mm)) +
  geom_histogram(bins = 20)
```

::::

::::

By default `geom_histogram` choses 30 bins. This default value has been chosen
because it is almost never the correct choice. `ggplot2` is an opinionated
package, that tries to force us to make better plots. 

## How many bins should we chose?

We should chose the number of bins that best tells the story we want to tell 
about our data. But also the number of bins that does not hide information
about our data. 

The obvious way to do this is to fiddle with the number of bins, and find the
number that best do that. 

But that can feel a bit cheaty. How do we rationalise the number of bins in a 
way that makes sure that this number is not just the one that show what we 
_want_ the data to show, but the number that actually show the data as it is.

A number of heuristics for chosing the "correct" number of bins exist.

::::spoiler
## Why do we call it a heuristic?

A heuristic is a fancy way of saying "rule of thumb". "Heuristic" sounds like 
we know what we are talking about. 

::::



## tommelfingerregler

Der er andre tommelfingerregler at følge.

I det følgende er der tre betegnelser vi bruger igen og igen.

Antallet af bins kalder vi `k`. I ovenstående graf er k defaultværdien
30. 

Bredden af bins kalder vi `h`. Den finder vi ved at tage den mindste 
værdi i datasættet, trække den fra den største værdi i datasættet (det
er datasættes range), og dividere med antallet af bins.

Antallet af observationer kalder vi `n`.

Og så er der nogle mærkelige paranteslignende tegn: $\lceil$ og $\rceil$.
Det er en såkaldt ceiling funktion. Den betyder blot, at når vi skal runde tallene op. 

Bemærk at vi skal ikke runde *af* . Vi skal runde *op*: 4.01 skal rundes op til 5. Funktionen `ceiling()` hjælper os med det.

### Freedman-Diaconis 

Bredden af bins skal sættes til: 

$h = 2*IQR*n^{-1/3}$

Udtrykket `IQR` får vi direkte fra funktionen `IQR()`

### Kvadratrodsreglen

Antallet af bins findes på denne måde: 

$k = \lceil\sqrt{n}\rceil$

### Sturges-reglen

$k = \lceil\log_2(n) + 1\rceil$

Bemærk at det implicit antages at data er ca. normalfordelte.

### Rice reglen

$k = \lceil2*n^{-1/3}\rceil$


### Doanes formel

$$k= 1 + \log_2(n) + \log_2(1+ |g_1|/\sigma_{g1})$$

hvor $g_1$ er den estimerede 3. moments skewness af fordelingen, og 
$\sigma_{g1} = \sqrt{6(n-2)/((n+1)*(n+3))}$.

Den er en modifikation af Sturges, der forsøger at give bedre resultater
når data ikke er normalfordelte.

Skewness kan vi beregne ved hjælp af en funktion vi får fra pakken
`moments`:
```{r}
library(moments)
skewness(penguins$bill_length_mm, na.rm = T)
```

### Scott's regel 

Finder bredden h ved: 

$h = 3.49 \frac{\sigma}{n^{-1/3}}$, 

hvor sigma er standardafvigelsen af stikprøven.


## That is difficult

Rather than doing these calculations on our own, we can read the help file for
the `hist()` function. The argument `breaks` allow us to specify where the
breaks in the histogram - the splits in bins - should occur. 

We can see that the default value is "Sturges". And under details we can 
see the other options that `hist()` can work with, "Scott" and "FD" for 
Freedman-Diaconis. We also get a hint of the functions that can return 
the number of bins:

```{r}
nclass.Sturges(penguins$bill_length_mm)
```
`nclass.FD` and `nclass.scott` works similarly, but note that it is necessary
to remove missing values.


::::spoiler
### Shimazaki and Shinomoto - a very fancy way of doing it

This heuristic is described in Shimazaki and Shinomoto. Neural Comput, 2007, 19(6), 1503-1527. 

Divide the range in N bins with a width of $\Delta$. Count the number of observations
in each bin. Call that $k_i$ where the "i" denotes which bin we are looking at.

Calculate the mean k, and variance v of observations in each bin:

$k = 1/n \sum_{i=1}^{N} k_i$

$v = 1/N \sum_{i=1}^N(k_i - k)^2$

Now calculate a new value $C(\Delta)$:

$$C(\Delta) = 2k - v/\Delta^2$$

Adjust $\Delta$ to minimize $C(\Delta)$.

::::

## Another way

We are able to define the bins in two ways. We can specify the number of bins
and we can specify the width of the bins. With a given range of data, those are
equivalent. A better way of specifying them will often be to specify the 
breaks. Remember that the default 30 bins leads to a width of the bins of
0.9noget mm. Which means that the first bin counts bill lenghts in the 
range NOGET TIL NOGET.

Instead of that, it is often a good idea to chose more meaningful breaks

MED HELE TAL OG SÅDAN NOGET.

`geom_histogram` i ggplot2 understøtter ikke at man kan angive hvilken
metode man ønsker at bruge til at beregne breaks i ens data. Så
der må man gøre det selv, eksempelvis med Sturges:

```{r}
bins <- ceiling(log2(length(penguins$bill_length_mm))) + 1
penguins %>% 
  ggplot(aes(x = bill_length_mm)) +
  geom_histogram(bins = bins)
```


Bruger man i stedet en metode der giver os bredden af bins, 
binwidth, gøres det på denne måde:

```{r}
binwidth <- 2*IQR(penguins$bill_length_mm, na.rm = T)*length(penguins$bill_length_mm)^(-1/3)

penguins %>% 
  ggplot(aes(x = bill_length_mm)) +
  geom_histogram(binwidth = binwidth)
```

## Hvilken skal man så vælge?

Man skal vælge det antal bins, eller den bredde af bins, der 
viser hvad man gerne vil have frem i sit histogram. 

Når man så har fundet ud af at 11 bins er det bedste antal, så 
finder man den tommelfingerregel af de ovenstående, der giver tallet
11, og forklarer at antallet af bins er valgt efter den regel.


We can use a function to make the choice. The package `healthyR` has been 
written to work with medical data, and includes the function `opt_bin`,
that claims to find the optimal number of bins:


```{r, warnings = FALSE, message=FALSE}
library(healthyR)
healthyR::opt
penguins %>% 
  filter(!is.na(bill_length_mm)) %>% 
  opt_bin( bill_length_mm)
```
Som det fremgår er man nødt til at fjerne NA-værdier selv, funktionen
har ikke et na.rm argument. Og det vi får ud, er ikke antallet af bins,
men de breaks der skal være i data for at vi får de 18 bins som 
funktionen siger at vi skal have.




::::keypoints
  - "FIXME"
::::
